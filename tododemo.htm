<html>
<head>
  <script src="bower_components/deepstream.io-client-js/dist/deepstream.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/vue/0.12.1/vue.min.js"></script>
</head>
<body>

  <div id="todolist">
    <ul>
      <li v-repeat="items" v-on="click: toggle">
        <label>
          <input type="checkbox" checked="{{done}}">
          {{text}}
        </label>
      </li>
    </ul>

    <input type="text" v-model="newItemName" placeholder="New Item">
    <button v-on="click: newItem">Add</button>
  </div>

  <script>
    var ds = deepstream("au.awg.nz:6020").login();
    var list = ds.record.getList("todos");
    function wrapRecord(record) {
      record.subscribe(function(data) {
        for (var prop in data)
          if (data.hasOwnProperty(prop))
            record.$set(prop, data[prop]);
      });
      return record;
    }
    var todo = new Vue({
      el: "#todolist",
      data: {
        items: []
      },
      methods: {
        toggle: function(ev) {
          if (ev.target.checked != undefined)
            todo.items[ev.targetVM.$index].set("done", ev.target.checked);
        },
        newItem: function() {
          var name = "todos/" + ds.getUid();
          var record = ds.record.getRecord(name);
          record.set({text: this.newItemName, done: false});
          list.addEntry(name);
        },
      },
      ready: function() {
        list.subscribe(function(data) {
          data.forEach(function(name) {
            var record = ds.record.getRecord(name);
            record.whenReady(function() {
              todo.items.push(wrapRecord(record));
            });
          });
        });
      }
    });
  </script>
</body>
</html>
